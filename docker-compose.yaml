version: "3.9"
networks:
  internal-net:
    external: true

services:
  redis:
    image: redis:7-alpine
    container_name: transcribe-redis
    command: ["redis-server", "--requirepass", "your-redis-password"]
    restart: unless-stopped
    networks: 
    - internal-net
    
  transcribe-api:
    build: .
    container_name: transcribe-api
    environment:
      TZ: Asia/Jakarta
      ROLE: api
      PYTHONUNBUFFERED: "1"
      REDIS_URL: redis://:your-redis-password@redis:6379/0
      STORAGE_DIR: /data
      MODEL_SIZE: small        # tiny | base | small | medium | large-v3
      DEVICE: cpu              # cpu | cuda (kalau ada GPU)
      COMPUTE_TYPE: int8       # cpu: int8 / int8_float16; gpu: float16
      MAX_CONCURRENCY: "2"
      JOB_TTL_SECONDS: "86400"

    volumes:
      - transcribe-data:/data
      - transcribe-cache:/root/.cache
    depends_on: 
    - redis
    restart: unless-stopped
    networks: 
        - internal-net

  transcribe-worker:
    build: .
    container_name: transcribe-worker
    environment:
      TZ: Asia/Jakarta
      ROLE: worker
      PYTHONUNBUFFERED: "1"
      REDIS_URL: redis://:your-redis-password@redis:6379/0
      STORAGE_DIR: /data
      MODEL_SIZE: small
      DEVICE: cpu
      COMPUTE_TYPE: int8
      MAX_CONCURRENCY: "2"     # worker CPU 6 core: mulai 1 dulu, naikkan jika aman
      JOB_TTL_SECONDS: "86400"
    volumes:
      - transcribe-data:/data
      - transcribe-cache:/root/.cache
    depends_on: 
      - redis
    restart: unless-stopped
    networks: 
        - internal-net

volumes:
  transcribe-data:
  transcribe-cache:
